# 演習4

スタティックルートとダイナミックルートを用意し、基本的にはスタティックルートを、スタティックルートで行けない場合にダイナミックルートで通信できるように設定してください。

---

対象：Packet Tracer / Cisco IOS  
構成：rt01—rt02—rt04 と rt01—rt03—rt04 の **2経路**がある“ひし形”トポロジ

---

## 0. 目的（要件の言い換え）
- 通常時：**スタティックルートを優先**して通信する  
- スタティックで通れない障害時：**ダイナミックルート（OSPF）**で迂回して通信を継続する  
- ※単にスタティックとOSPFを併用するだけだと「スタティックが残り続けてブラックホール」になり得るため、  
  本手順書では **IP SLA + track** で “通れない時はスタティックを自動撤去” する（実務寄りの完成形）

---

## 1. 構成図（あなたの図の内容を固定）
### 1-1. ルータ間リンクとIP
- **rt01—rt02：172.31.0.0/24**
  - rt01 Gi0/0/0：`172.31.0.1/24`
  - rt02 Gi0/0/0：`172.31.0.2/24`
- **rt01—rt03：172.31.1.0/24**
  - rt01 Gi0/0/1：`172.31.1.1/24`
  - rt03 Gi0/0/0：`172.31.1.3/24`
- **rt02—rt04：172.31.2.0/24**
  - rt02 Gi0/0/1：`172.31.2.2/24`
  - rt04 Gi0/0/0：`172.31.2.4/24`
- **rt03—rt04：172.31.3.0/24**
  - rt03 Gi0/0/1：`172.31.3.3/24`
  - rt04 Gi0/0/1：`172.31.3.4/24`
  
![alt text](<スクリーンショット 2026-02-18 135651.png>)

### 1-2. 使う経路（優先／バックアップ）
- 優先（スタティック）：**rt01 → rt02 → rt04**
- バックアップ（OSPF）：**rt01 → rt03 → rt04**

> つまり、rt01↔rt04 間の到達性について「通常はrt02経由」「rt02経由が死んだらrt03経由」を実現する。

---

## 2. 完了条件（チェックリスト）
- [ ] 4リンクすべて `up/up`
- [ ] OSPF隣接が張れている（rt01はrt02/rt03と隣接、rt04はrt02/rt03と隣接）
- [ ] 通常時：`show ip route` で **Static（S）** が選ばれる
- [ ] 障害時：track が down → Static が消える → **OSPF（O）** が選ばれる
- [ ] ping/traceroute で経路が切り替わることが確認できる

---

## 3. 事前：L3IFのIP設定（もし未設定なら）
> すでに設定済みならスキップしてOK。  
> 各ルータで `show ip interface brief` を打って、以下のIPで `up/up` になっていることだけ確認する。

---

## 4. ダイナミックルート（OSPF）を全ルータに設定（バックアップ経路）
> まず **OSPFで全到達性**を作る。  
> その上で、スタティックを入れて“普段は静的が勝つ”状態にする。

### 4-1. rt01（OSPF 10 / Area 0）
```ios
rt01# configure terminal
rt01(config)# router ospf 10
rt01(config-router)# network 172.31.0.0 0.0.0.255 area 0
rt01(config-router)# network 172.31.1.0 0.0.0.255 area 0
rt01(config-router)# end
```

### 4-2. rt02
```ios
rt02# configure terminal
rt02(config)# router ospf 10
rt02(config-router)# network 172.31.0.0 0.0.0.255 area 0
rt02(config-router)# network 172.31.2.0 0.0.0.255 area 0
rt02(config-router)# end
```

### 4-3. rt03
```ios
rt03# configure terminal
rt03(config)# router ospf 10
rt03(config-router)# network 172.31.1.0 0.0.0.255 area 0
rt03(config-router)# network 172.31.3.0 0.0.0.255 area 0
rt03(config-router)# end
```

### 4-4. rt04
```ios
rt04# configure terminal
rt04(config)# router ospf 10
rt04(config-router)# network 172.31.2.0 0.0.0.255 area 0
rt04(config-router)# network 172.31.3.0 0.0.0.255 area 0
rt04(config-router)# end
```

### 4-5. OSPF確認（必須）
各ルータで確認：

```ios
show ip ospf neighbor
show ip route ospf
```

---

## 5. スタティックルート（優先経路）を “track付き” で設定
> 静的を優先にするだけなら `ip route ...` で足りるが、障害時に自動で切替させるため **track** を使う。

### 5-1. rt01：IP SLA/track（優先次ホップ rt02=172.31.0.2 を監視）
```ios
rt01# configure terminal
rt01(config)# ip sla 1
rt01(config-ip-sla)# icmp-echo 172.31.0.2 source-interface gigabitEthernet 0/0/0
rt01(config-ip-sla)# frequency 5
rt01(config-ip-sla)# exit
rt01(config)# ip sla schedule 1 life forever start-time now
rt01(config)# track 1 ip sla 1 reachability
rt01(config)# end
```

確認：
```ios
rt01# show ip sla statistics
rt01# show track 1
```

### 5-2. rt01：track付きスタティック（rt04側ネットワーク宛）
```ios
rt01# configure terminal
rt01(config)# ip route 172.31.2.0 255.255.255.0 172.31.0.2 track 1
rt01(config)# ip route 172.31.3.0 255.255.255.0 172.31.0.2 track 1
rt01(config)# end
```

---

### 5-3. rt04：IP SLA/track（優先次ホップ rt02=172.31.2.2 を監視）
```ios
rt04# configure terminal
rt04(config)# ip sla 1
rt04(config-ip-sla)# icmp-echo 172.31.2.2 source-interface gigabitEthernet 0/0/0
rt04(config-ip-sla)# frequency 5
rt04(config-ip-sla)# exit
rt04(config)# ip sla schedule 1 life forever start-time now
rt04(config)# track 1 ip sla 1 reachability
rt04(config)# end
```

### 5-4. rt04：track付きスタティック（rt01側ネットワーク宛）
```ios
rt04# configure terminal
rt04(config)# ip route 172.31.0.0 255.255.255.0 172.31.2.2 track 1
rt04(config)# ip route 172.31.1.0 255.255.255.0 172.31.2.2 track 1
rt04(config)# end
```

---

### 5-5. ルーティング確認（通常時：Staticが勝つ）
rt01：
```ios
rt01# show ip route 172.31.2.0
rt01# show ip route 172.31.3.0
```

rt04：
```ios
rt04# show ip route 172.31.0.0
rt04# show ip route 172.31.1.0
```

期待：
- `S`（Static）が選ばれている  
- `via` が優先次ホップ（rt01なら172.31.0.2、rt04なら172.31.2.2）

---

## 6. 疎通確認（通常時：スタティック経由）
rt01 → rt04直結IPへ：
```ios
rt01# ping 172.31.2.4
rt01# ping 172.31.3.4
```

経路確認：
```ios
rt01# traceroute 172.31.2.4
```
期待：1 hop目が `172.31.0.2`（rt02）

---

## 7. 障害試験：スタティックが使えない時に OSPFへ切替できるか
### 7-1. 優先経路を落とす（例：rt01—rt02リンクを落とす）
```ios
rt01# configure terminal
rt01(config)# interface gigabitEthernet 0/0/0
rt01(config-if)# shutdown
rt01(config-if)# end
```

### 7-2. 切替確認（track/down と ルート種別）
```ios
rt01# show track 1
rt01# show ip route 172.31.2.0
```
期待：`S` が消え、`O`（OSPF）が選ばれる（rt03経由）

### 7-3. 疎通・経路確認
```ios
rt01# ping 172.31.2.4
rt01# traceroute 172.31.2.4
```
期待：1 hop目が `172.31.1.3`（rt03）に変わる

### 7-4. 復旧（元に戻す）
```ios
rt01# configure terminal
rt01(config)# interface gigabitEthernet 0/0/0
rt01(config-if)# no shutdown
rt01(config-if)# end
```
期待：track Up → `S` 復活 → rt02経由に戻る

---

## 8. 失敗時の切り分け（最短）
1) IFが up/up か  
```ios
show ip interface brief
```

2) OSPF隣接が張れているか  
```ios
show ip ospf neighbor
```

3) track が Up/Down になっているか  
```ios
show track 1
show ip sla statistics
```

4) ルートがどれで選ばれているか（SかOか）  
```ios
show ip route <宛先ネットワーク>
```

---

## 9. （推奨）設定保存
```ios
copy running-config startup-config
```