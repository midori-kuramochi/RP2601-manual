チーム演習１

[ストーリー]
とある企業にて、新規事業を立ち上げると発表がありました。
事業の内容としては、wordpressをマネージドで提供するサービスです。
顧客ごとにWordpressのページを用意します。
インフラチームには下記の要件で依頼が来ました。

[要件]

### ネットワーク
VPC:1
サブネット:4
 - サブネットは必ずゾーンを分ける
 - サブネットはパブリックサブネットとプライベートサブネットに分ける
 - パブリックサブネットにあるサーバにはEIPを付与してください。
 - それ以外のサーバーはパブリックIPを無効にしてください。

### DNS(外部)
1. entrycl.netから各チームサブドメインを払い出してもらう。（teamX.entrycl.net）
2. 顧客ごとに、払い出してもらったドメインからさらにサブドメインを払い出す。
（例：sanma.teamX.entrycl.net, maguro.teamX.entrycl.net, shake.teamX.entrycl.net）

### DNS（内部）
ドメイン：wp.local
各サーバ間通信はすべてホスト名で通信すること
例）web-01.wp.local

### NTP
全サーバにて、構築したNTPサーバと時刻同期できるようにしてください。
NTPサーバの指定はホスト名で指定すること

### NFS
 - メール受信ディレクトリを共有
 - Apacheのドキュメントルート用ディレクトリも共有してください。
 - 他にも共有したいディレクトリがあれば共有しましょう。
   OS再起動後もマウントできるように設定しましょう。

### メール
顧客ごとにユーザーを作成しメールアドレスを用意してください。
例）banana@team99.entrycl.net
Outlookからメールを送り受信ができるようにしてください。
Dovecotを構築し、ユーザーごとにメールが受信できていることを確認してください。

### Web
Apacheを使用してください。
顧客は3社ある想定で、サブドメインごとに顧客がアクセスできるようにしてください。（例）banana.team99.entrycl.net, ringo.team99.entrycl.net, tomato.team99.entrycl.net
[apache virtualhost 名前ベース]などで調査してみてください。

### AP
Wordpressをインストールしてください。
冗長化してください。(Apacheのmod_proxy_balancerがヒント)

### DB
Databaseは顧客ごとに3つ用意してください。
mariadbを使ってください。

[ルール]
構成は下記の通り
 - Web+DNS(外部)+Postfix
 - DNS(外部)+Postfix (x1)
 - AP+DNS(内部) (x2)
 - DB+Dovecot+NTP+NFS(x1)

---

## ステップ1. VPC,サブネット,インスタンス,ssh

### [VPC]  


### [サブネット]
サブネット作成
VPCサービスから左メニューの「サブネット」画面右上の「サブネットの作成」をクリック

「VPC_ID」→代表者が作成したVPCを選択 「サブネット名」→各自自由 「アベイラビリティゾーン」→サブネットがチームメンバーと被らないように選択 「IPv4 CIDR」→10.0.0.0/24(作成したVPCネットワークアドレスから切り出す形で決める) ＊アベイラビリティゾーンが他のサブネットと異なるときIPv4 CIDRは同じにできないので10.0.1.0/24などと変更する 「新しいサブネットを作成」

### [インターネットゲートウェイの作成]
   -　左メニューからインターネットゲートウェイを選び、右画面の「インターネットゲート　　　ウェイの作成」をクリック
   -　「名前タグ」→自由につけ
   -　対象を選択した状態でアクションからVPCにアタッチをクリックしサブネットとイン　　　　ターネットゲートウェイをアタッチ

### [ルートの編集]
ルートテーブルの作成を選択し、ルートテーブルのリンクを選択する。
（今回の場合はプライベート用とパブリック用で２個作成）
　  -　プライベートは0,0,0,0/0、パブリックは172,31,0,0/



### 踏み台サーバからprivateサブネット内のサーバへのログイン方法

1. ローカルでSSHエージェントを起動
   まず、鍵をメモリに保持するためのエージェントを立ち上げます。
   ```
   eval `ssh-agent`
   ```

2. 秘密鍵をエージェントに登録
   あなたのローカルにある鍵（例: CL_kuramochi.pem）を登録します。
   ```
   ssh-add ./.ssh/CL_kuramochi.pem
   ```

3. エージェント転送を有効にして踏み台へログイン
   -A オプションをつけるのがポイントです。これにより、踏み台サーバーがローカルの鍵を「借りる」ことができるようになります。
   ```
   ssh -A ec2-user@<踏み台サーバーのパブリックIP>
   ```

4. 踏み台からプライベートサーバーへ
   踏み台にログインできたら、そのままプライベートサーバーへSSHします。鍵の指定（-i）は不要です。
   ```
   ssh ec2-user@<プライベートサーバーのプライベートIP>
   ```

### NATゲートウェイの作成
1. NAT ゲートウェイの作成
   左メニュー: [NAT ゲートウェイ] ＞ [NAT ゲートウェイを作成]
   - 名前: nat-gw-public (任意)
   - サブネット: パブリックサブネットを選択（※重要：Privateではない）
   - 接続タイプ: パブリック
   - Elastic IP 割り当て ID: [Elastic IP を割り当て] ボタンをクリックして取得
   - 作成: [NAT ゲートウェイを作成] をクリック
   - 注: ステータスが「Available」になるまで数分待機します。

1. プライベートサブネット用ルートテーブルの設定
   - 左メニュー: [ルートテーブル]
   
   - 作成: [ルートテーブルを作成]
       - 名前: rtb-private (任意)
       - VPC: 対象の VPC を選択
  
   - ルートの編集: 作成したルートテーブルを選択 ＞ [ルート] タブ ＞ [ルートを編集]
       - [ルートを追加] をクリック
       - 送信先: 0.0.0.0/0
       - ターゲット: [NAT ゲートウェイ] を選択し、先ほど作成した  nat-xxxxxxxxxxxx を指定
       - [変更を保存] をクリック

   - サブネットの関連付け: [サブネットの関連付け] タブ ＞ [サブネットの関連付けを編集]
       - 対象: プライベートサブネットにチェックを入れて保存
---

## ステップ2. Wordpressのページ作成

### Public1 [Web+DNS(外部)+Postfixサーバ]

* セキュリティグループ
- ssh 22 MyIP
- http 80 MyIP
- DNS(UDP) 53 0.0.0.0/0


### Webサーバ(Apache)の構築

1. apacheのインストールおよび起動  
   <code> # dnf update -y </code>  
   <code> # dnf install httpd -y </code>  
   <code> # systemctl start httpd </code>  
   <code> # systemctl status httpd </code>    

2. apacheの起動確認  
   http://webサーバのプライベートIPアドレスを検索  
   →「It works!」の表⽰を確認。

3. APサーバとの接続  
   目的：
   Webサーバに来たPHPリクエストを、APサーバのPHP-FPMに転送するため  
   - PHP =「Webページを動的に作るためのプログラミング言語」  
           例）WordPressを表示する
   - PHP-FPM = PHPをFastCGI経由で実行するためのプロセスマネージャ  
            - FPM = FastCGI Process Manager  
            - FastCGI：Webサーバから「PHP実行して!」って頼まれる方式  
            - Process Manager：PHPを実行する人（プロセス）を管理する係
  
  3-1. php-fpmをダウンロード（/etc/httpd/conf.d配下にphp.confを追加するため）  
       <code> # dnf install php-fpm -y </code>  
       目的：  
         mod_proxy_fcgi を使って FastCGI 転送するため  
         Apache が「PHPファイルをどう扱うか」を定義する設定ファイルが必要

  3-2. php.confファイルの修正  
       <code> # vi /etc/httpd/conf.d/php.conf </code>   
       ▼デフォルト  
       <FilesMatch \.(php|phar)$>  
       SetHandler "proxy:unix:/run/php-fpm/www.sock|fcgi://localhost"  
       </FilesMatch>  

       ▼下記に修正（APサーバ1台の時）  
       <FilesMatch \.(php|phar)$>  
       SetHandler "proxy:fcgi://xxx.xxx.xxx.xxx(APサーバーのプライベートIP):8000"  
       </FilesMatch> 

       ※ドメインの場合
       <FilesMatch \.(php|phar)$> 
       SetHandler "proxy:fcgi://ap-01.wp.local:8000"
       </FilesMatch> 

       ※proxy:後のunix~まで削除しないと、WEBサーバ内のphpが反応してしまうため注意が必要。  

       ▼下記に修正（APサーバ2台以上の時_冗長化構成）
       - 必要モジュール（環境によっては既に有効）
          LoadModule proxy_module modules/mod_proxy.so  
          LoadModule proxy_fcgi_module modules/mod_proxy_fcgi.so  
          LoadModule proxy_balancer_module modules mod_proxy_balancer.so
          LoadModule slotmem_shm_module modules/mod_slotmem_shm.so  
          LoadModule lbmethod_byrequests_module modules/mod_lbmethod_byrequests.so  
       
       ※LoadModule =「この機能（モジュール）をApacheで使えるように読み込んでね」という宣言。
       ※すでに有効なら → 書かなくても動くことが多い

       - バランサ定義（AP 2台を登録）
         <Proxy "balancer://phpfpmcluster">
         BalancerMember "fcgi://ap-01.wp.local:9000" route=ap1
         BalancerMember "fcgi://ap-02.wp.local:9000" route=ap2
         ProxySet lbmethod=byrequests
         </Proxy>

         ※プール = 「投げ先リスト」
                   Apacheにとっての プール（balancer） は、「この処理を投げていいサーバ一覧」ただそれだけ。
         ※route = ap1 / ap2：その投げ先につけた 名前（ラベル）
       
       - PHPリクエストだけ balancer に流す
         <FilesMatch \.(php|phar)$>
         SetHandler "proxy:balancer://phpfpmcluster"
         </FilesMatch>
         ※ 意味：PHPが来たら、さっき作った phpfpmcluster（投げ先グループ） に投げて

  3-3. httpdの再起動
       <code> systemctl restart httpd </code>
  3-4. 念のためphp-fpmを停⽌
       <code> systemctl stop php-fpm </code>

4. ブラウザでのWordpressの表⽰準備
   4-1. Wordpressのダウンロードと解凍・バックアップの作成  
        <code> cd /usr/local </code>
        <code> wget https://wordpress.org/latest.tar.gz </code>
        <code> tar -xzf latest.tar.gz </code>
        <code> cp wordpress/wp-config-sample.php wordpress/wp-config.php </code>
   4-2. Wordpress配下を/var/www/html配下へ移動
        <code> cp -a wordpress/* /var/www/html/

5. 顧客ごとにWordpressのページを作成
   - 前提（例）
      - チームドメイン：teamX.entrycl.net
      - 顧客ドメイン：
        - aaa.teamX.entrycl.net
        - bbb.teamX.entrycl.net
        - ccc.teamX.entrycl.net

☆イメージ
  Internet
   │
   │ 名前解決（DNS）
   ▼
┌───────────────────────────────┐
│ Webサーバ（Public Subnet）     │
│ ・Apache                      │
│ ・外部DNS（bind/named）        │
│                               │
│ VirtualHost定義               │
│  ├ aaa.teamX.entrycl.net      │
│  ├ bbb.teamX.entrycl.net      │
│  └ ccc.teamX.entrycl.net      │
└───────────────────────────────┘

  5-1. virtualhostの設定
        Webサーバ(VirtualHost)：サブドメインごとにどのWordPressやコンテンツに振り分けるか決定
     <code> vi /etc/httpd/conf.d/virtualhost.conf </code>

[VirtualHost定義例]
<VirtualHost *:80>
    ServerName aaa.teamX.entrycl.net
    DocumentRoot /var/www/html/aaa
</VirtualHost>

<VirtualHost *:80>
    ServerName bbb.teamX.entrycl.net
    DocumentRoot /var/www/html/bbb
</VirtualHost>

<VirtualHost *:80>
    ServerName ccc.teamX.entrycl.net
    DocumentRoot /var/www/html/ccc
</VirtualHost>  

### DNS外部の設定

ゴール:
- aaa.teamX.entrycl.net / bbb... / ccc... が 名前解決できる
- ブラウザアクセスが Webサーバ（EIP）に到達する
- Apache が VirtualHostで振り分けする
- PHP（WordPress）は APサーバへ転送（mod_proxy_fcgi）

1. bindのインストールと設定
   <code> # dnf install bind -y </code>
   
   <code> # cp /etc/named.conf /etc/named.conf.`date +%Y%m%d-%H%M%S` </code>
   <code> # vi /etc/named.conf </code>
   【変更内容】
   // listen-on port 53 {127.0.0.1; };　※コメントアウト
   // listen-on-v6 port 53 {::1; };　　※コメントアウト
   // allow-query {localhost; };　　　　※コメントアウト
   allow-query {any; };　　　　　　　※追記
   
   zone "teamX.entrycl.net"IN{
      type master;
      file "/var/named/teamX.entrycl.net.zone";
      };
   
   <code> # named-checkconf </code>

2. ゾーン情報ファイルの作成
   <code> # vi /var/named/teamX.entrycl.net.zone </code>
   【変更内容】
   $TTL 3600
   @ IN SOA ns.teamX.entrycl.local. test.teamX.entrycl.local. (
   20210401 ; serial
   3600 ; refresh
   3600 ; retry
   3600 ; expire
   3600 ) ; minimum

        IN NS ns.teamX.entrycl.local.
    ns1  IN A 16.xxx.xxx.xxx (dns-01のEIP)
    ns2  IN A 16.xxx.xxx.xxx (dns-02のEIP)
    aaa  IN A 16.xxx.xxx.xxx (webサーバのEIP)
    bbb  IN A 16.xxx.xxx.xxx (webサーバのEIP)
    ccc  IN A 16.xxx.xxx.xxx (webサーバのEIP)

    
    ※間違いがないか確認
    <code> # named-checkzone teamX.entrycl.local /var/named/teamX.entrycl.local.zone </code>
    
    設定の反映
    <code> # systemctl restart named </code>
    <code> # systemctl status named </code>


3. 動作確認（超重要）
   <code> # dig @<dns-01のEIP> sanma.teamX.entrycl.net A </code>
   <code> # dig @<dns-02のEIP> sanma.teamX.entrycl.net A </code>
   <code> # dig ns.teamX.entrycl.local </code>
   <code> # dig aaa.teamX.entrycl.local </code>
   
   5-3. /var/www/html/配下にwpファイルを配置

   - Webサーバ/APサーバで顧客ディレクトリ作成
     <code> mkdir -p /var/www/html/{aaa,bbb,ccc} </code> 
     
     cp /etc/fstab /etc/fstab.bak
     vi /etc/fstab
     
     172.31.4.230:/srv/nfs/www/fruitzipper /var/www/html/fruitzipper nfs4 defaults 0 0
     172.31.4.230:/srv/nfs/www/candytune /var/www/html/candytune nfs4 defaults 0 0
     172.31.4.230:/srv/nfs/www/cutiestreet /var/www/html/cutiestreet nfs4 defaults 0 0

   - Webサーバ/APサーバでマウント
     <code> mount -a </code>
(
   - NFSサーバで共有ディレクトリを作成
     <code> mkdir -p /srv/nfs/www/{aaa,bbb,ccc} </code>

     cp /etc/exports /etc/exports.bak
     vi /etc/exports
     /srv/nfs/www/fruitzipper 172.31.0.0/16(rw,no_root_squash)
     /srv/nfs/www/candytune 172.31.0.0/16(rw,no_root_squash)
     /srv/nfs/www/cutiestreet 172.31.0.0/16(rw,no_root_squash)

     systemctl start nfs-server
     systemctl enable nfs-server

     <code> chown -R apache:apache /srv/nfs/www </code>
     <code> chmod -R 755 /srv/nfs/www </code>

   - Wordpressのダウンロードと解凍・バックアップの作成  
     <code> cd /usr/local </code>
     <code> wget https://wordpress.org/latest.tar.gz </code>
     <code> tar -xzf latest.tar.gz </code>
     <code> cp wordpress/wp-config-sample.php wordpress/wp-config.php </code>

   - Wordpress配下を/var/www/html配下へ移動
     <code> cp-a wordpress/* /srv/nfs/www/aaa/ </code>
     <code> mv wordpress/* /srv/nfs/www/bbb/ </code>
     <code> mv wordpress/* /srv/nfs/www/ccc/ </code>
      ※WordpressはAPサーバとWEBサーバの両⽅のhtml配下に置く必要がある
)  

---

### Private1 [AP+DNS(内部)サーバ]

* セキュリティグループ
- ssh 22 VPCCIDR
- DNS(UDP) 53 0.0.0.0
-

### APサーバ構築

1. phpのインストールおよび起動
   <code> dnf install php php-fpm php-mysqli php-json php php-devel -y </code>
   <code> systemctl start php-fpm </code>
   <code> systemctl status php-fpm </code>

2. /etc/php-fpm.d/www.conf内の修正
   1. バックアップ作成
      cp /etc/php-fpm.d/www.conf /etc/php-fpm.d/www.conf.`date +%Y%m%d-%H%M%S`
      ls /etc/php-fpm.d | grep www.conf
   2. vi /etc/php-fpm.d/www.conf
   ▼下記に修正
   ;listen = /run/php-fpm/www.sock
   →listen = xxx.xxx.xxx.xxx(APサーバーのプライベートIP):8000
   ;listen.allowed_clients = 127.0.0.1
   →listen.allowed_clients = xxx.xxx.xxx.xxx(WebサーバーのプライベートIP)
   ※コメントアウト=「#」じゃなくて、「;」

3. php-fpmの再起動
   <code> systemctl restart php-fpm </code>

4. phpinfoを表⽰するために、phpinfo.phpファイルを作成
   （APサーバに配置する必要あり。WEBサーバには不要）
   <code> echo "<?php phpinfo(); ?>" > /var/www/html/phpinfo.php </code>
   ※ <?php phpinfo(); ?> = 「PHPとして実行される最小のプログラム」
      <?php … PHPモード開始
      ?> … PHPモード終了
      phpinfo … PHP自身の情報を全部表示する
      () … 関数を「実行する」ための記号
      ; … 命令の終わり

5. apacheによりphpが表⽰できているか確認
   http://webサーバのプライベートIPアドレス/phpinfo.php 
   → ※phpinfo.php はAPサーバに存在するが、
       Webサーバ経由でアクセスし、
       PHP処理がAPサーバで実行されていることを確認する。

6. WordPressがファイルを書き換えられるように、所有者をApacheに変更
   <code> chown -R apache:apache /var/www/html/ </code>

7. APサーバでWordpressの構築
   7-1. Wordpressのダウンロードと解凍・バックアップの作成
        <code> cd /usr/local </code>
        <code> wget https://wordpress.org/latest.tar.gz </code>
        <code> tar -xzf latest.tar.gz </code>

   7-2. Wordpress配下を/var/www/html配下へ移動
        <code> cp -a wordpress/* /var/www/html/ </code>

   7-3. wp-config.phpの修正
        <code> cp wordpress/wp-config-sample.php wordpress/wp-config.php </code>
        <code> vi /var/www/html/wp-config.php </code>
        ===変更箇所==========================
        define( 'DB_NAME', 'wordpress-db' );
        /** Database username */
        define( 'DB_USER', 'wordpress-user' );
        /** Database password */
        define( 'DB_PASSWORD', 'wordpress-password' );
        /** Database hostname */
        define( 'DB_HOST', 'xxx.xxx.xxx.xxx(DBサーバーのプライベートIP)' );

7-4. APサーバとDBサーバが接続しているかを確認
     <code> dnf install mariadb105-server -y </code>
     <code> mysql -u wordpress-user -h DBサーバのプライベートID -p wordpress-db </code>

### 内部DNSサーバの構築

1. bindのインストールと設定
   <code> # dnf install bind </code>
   
   <code> # vi /etc/named.conf </code>
   【変更内容】
   // listen-on port 53 {127.0.0.1; };　※コメントアウト
   // listen-on-v6 port 53 {::1; };　　※コメントアウト
   // allow-query {localhost; };　　　　※コメントアウト
   allow-query {any; };　　　　　　　※追記
   
   zone "wp.local"IN{
      type master;
      file "/var/named/wp.local.zone";
      };
   
   <code> # named-checkconf </code>

2. ゾーン情報ファイルの作成
   <code> # vi /var/named/wp.local.zone </code>
   【変更内容】
   $TTL 3600
   @ IN SOA ns.wp.local. test.wp.local. (
   20210401 ; serial
   3600 ; refresh
   3600 ; retry
   3600 ; expire
   3600 ) ; minimum
           IN NS ns.wp.local.
    ns     IN A 172.31.3.39 (ap-01のprivateIP)
    ns     IN A 172.31.3.97 (ap-02のprivateIP)
    web-01 IN A 172.31.1.31
    dns-01 IN A 172.31.2.53
    db-01  IN A 172.31.4.218
    
    ※間違いがないか確認
    <code> # named-checkzone wp.local /var/named/wp.local.zone </code>
    
    設定の反映
    <code> # systemctl restart named </code>
    <code> # systemctl status named </code>

3. 動作確認（超重要）
   <code> # dig ap-01.wp.local </code>
   <code> # dig db-01.wp.local </code>
   <code> # ping web-01.wp.local </code>

4. 全サーバの名前解決先（nameserver）を内部DNSに向ける
   ※内部DNS以外のサーバで実行
   <code> # vi /etc/systemd/resolved.conf </code>
   【変更内容】
   DNS=172.31.3.39 , 172.31.3.97
   <code> systemctl restart systemd-resolved.service </code>

---

### Private2 [DB+Dovecot+NTP+NFSサーバ]

- セキュリティグループ
- ssh 22 VPCCIDR
| サービス               | ポート  | プロトコル | 送信元          | 用途                  |
| ------------------ | ---- | ----- | ------------ | ------------------- |
| **MariaDB**        | 3306 | TCP   | APサーバSG      | WordPress / アプリDB接続 |
| **Dovecot (IMAP)** | 143  | TCP   | Web/管理者IP    | メール受信（平文）           |
| （任意）IMAPS          | 993  | TCP   | Web/管理者IP    | メール受信（SSL）          |
| **NTP**            | 123  | UDP   | VPC内         | 時刻同期                |
| **NFS**            | 2049 | TCP   | Web/APサーバSG  | ファイル共有              |
| **SSH**            | 22   | TCP   | 踏み台 or 管理者IP | 管理用                 |


1. mariadbのインストールおよび起動と本番環境の準備
   <code> # dnf update -y </code>
   <code> # dnf install mariadb105-server -y </code>
   <code> # systemctl start mariadb </code>
   <code> # systemctl status mariadb </code>
   <code> # mysql_secure_installation </code>
   --------------------------------------------------
   1. rootパスの入⼒、デフォルトは設定されていないためエンターキー  
      >Enter current password for root (enter for none): Enter
   2. 接続をリモート可能にするか設定、ローカル接続のみにする場合はY  
      >Switch to unix_socket authentication [Y/n] Y
   3. rootパスワードを変更する場合Y
      >Change the root password? [Y/n] Y
   4. 匿名ユーザアカウントを削除する場合Y
      >Remove anonymous users? [Y/n] Y
   5. リモートルートログインを無効にする場合Y
      >Disallow root login remotely? [Y/n] Y
   6. テストデータベースを削除する場合Y
      >Remove test database and access to it? [Y/n] Y
   7. 権限テーブルをリロードし、変更を保存する場合Y
      >Reload privilege tables now? [Y/n] 

2. DB作成
   <code> # mysql -u root -p </code>
   MariaDB [(none)]> CREATE DATABASE `wordpress-db`;
   MariaDB [(none)]> CREATE USER 'wordpress-user'@'xxx.xxx.xxx.xxx(APサーバーのプライベートIP)' IDENTIFIED BY 'wordpress-password';
   MariaDB [(none)]> GRANT ALL PRIVILEGES ON `wordpress-db`.* TO "wordpress-user"@"APサーバーのプライベートIP";
   MariaDB [(none)]> FLUSH PRIVILEGES;

---

## ステップ3. メール受信設定

### Public1 [Web+DNS(外部)+Postfixサーバ]

* セキュリティグループ
- ssh 22 MyIP
- http 80 MyIP
- DNS(UDP) 53 0.0.0.0/0


### メールサーバ(Postfix)の構築

dnf install postfix -y
systemctl start postfix
ps -ef | grep postfix
>root       37244       1  0 08:31 ?        00:00:00 /usr/libexec/postfix/master -w
postfix    37245   37244  0 08:31 ?        00:00:00 pickup -l -t unix -u
postfix    37246   37244  0 08:31 ?        00:00:00 qmgr -l -t unix -u
root       37248   31653  0 08:31 pts/10   00:00:00 grep --color=auto postfix

netstat -ln | grep 25
>tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN
unix  2      [ ACC ]     STREAM     LISTENING     73425    public/qmgr
unix  2      [ ACC ]     STREAM     LISTENING     66448    /tmp/ssh-XXXXRWorXw/agent.34125
unix  2      [ ACC ]     STREAM     LISTENING     66983    /tmp/ssh-XXXXRNCfJs/agent.34251

dnf install mailx -y


### メールサーバ構築手順書（Postfix + Dovecot / POP3）
0. ゴール
   - fruitszipper@kuramochi.entrycl.net など顧客ごとのメールアドレスを作る
   - Outlookから 送信(SMTP) と 受信(POP3) ができる
   - 受信はDovecot（POP3）で、ユーザーごとに受信できることを確認する

1. 構成（役割）
   [構成]
   - Web+DNS(外部)+Postfix　：　インターネットからメールを受け取る入口（SMTP受信）
   - DNS(外部)+Postfix (x1)　：　予備のメール受け口（余力があればMXを2本にする）
   - AP+DNS(内部) (x2)　：　今回のメール作業では基本触らない
   - DB+Dovecot+NTP+NFS(x1)　：　メールボックス保存（Maildir）/ POP3サーバ（Outlook受信の接続先）

1. セキュリティグループ（必須）
   - Web + 外部DNS + Postfix（Public）
      - TCP 25：SMTP受信（インターネット→Postfix）
      - UDP/TCP 53：外部DNS（named）
      - TCP 22：SSH（管理者IPのみ）
   - DB + Dovecot（Private）
      - TCP 25：Web(Postfix) → DB(配送用Postfix) 中継
      - TCP 110：POP3（Outlook受信）
      - TCP 22：SSH（踏み台 or 管理者IP）
        ※注意：DB（POP3）はPrivateなので、Outlookから直接つなぐ場合は到達経路（踏み台＋ポートフォワード等）が必要。

1. 外部DNS（Webサーバ）設定：A / MX を作る
   1. named設定（ゾーン追加）
      ```
      cp /etc/named.conf /etc/named.conf.`date +%Y%m%d-%H%M%S`
      vi /etc/named.conf
      /etc/named.conf にゾーン定義（例）：
      zone "kuramochi.entrycl.net" IN {
         type master;
         file "/var/named/kuramochi.entrycl.net.zone";
         };
      ```
      ※すでにステップ2で作成済みの場合不要
   2. ゾーンファイル作成
      ```
      /var/named/kuramochi.entrycl.net.zone
      $TTL 3600
      @ IN SOA ns.kuramochi.entrycl.net. test.kuramochi.entrycl.net. (
         2026021301
         3600
         900
         604800
         3600 )
                 IN NS ns.kuramochi.entrycl.net.
                 ns      IN A  <WebサーバEIP>
         ; Web（必要なら）
         fruitzipper IN A <WebサーバEIP>
         candytune   IN A <WebサーバEIP>
         cutiestreet IN A <WebサーバEIP>
         
         ; Mail受け口（Postfix）
         mail    IN A <WebサーバEIP>
         @       IN MX 10 mail.kuramochi.entrycl.net.
   チェック＆反映：
   named-checkconf
   named-checkzone kuramochi.entrycl.net /var/named/kuramochi.entrycl.net.zone
   systemctl restart named
   systemctl status named
   
   3. 確認：
      ```
      dig @localhost MX kuramochi.entrycl.net
      dig @localhost A mail.kuramochi.entrycl.net
      ```

1. DB+Dovecotサーバ：メールユーザー作成（顧客ごと）
   例：banana / apple を作る
   1. useradd -m banana
      passwd banana
   1. useradd -m apple
      passwd apple

2. DB+Dovecotサーバ：配送用 Postfix（ローカル配送）
   DBサーバ側にもPostfixを入れて「Maildirに保存」させるのが一番簡単。
   インストール＆起動：
   dnf install -y postfix
   systemctl enable --now postfix
   
   設定（/etc/postfix/main.cf）最低限：
   myhostname = db-mail.wp.local
   mydomain = kuramochi.entrycl.net
   myorigin = $mydomain
   
   ☆DB側はローカル配送が主なので、$mydomain を mydestination に入れない（混乱防止）
   mydestination = $myhostname, localhost.$mydomain, localhost
   inet_interfaces = all
   home_mailbox = Maildir/

3. 反映：
   postfix check
   systemctl restart postfix


Maildir作成（ユーザーごと）：

dnf install -y dovecot  # maildirmake用（入ってなければ）
su - banana -c 'maildirmake ~/Maildir'
su - apple  -c 'maildirmake ~/Maildir'

1. DB+Dovecotサーバ：Dovecot（POP3）

インストール＆起動：

dnf install -y dovecot


設定（POP3有効化）

/etc/dovecot/dovecot.conf（または該当conf）：

protocols = pop3


メール保存先（Maildir）

/etc/dovecot/conf.d/10-mail.conf：

mail_location = maildir:~/Maildir


起動：

systemctl enable --now dovecot
systemctl status dovecot


待受確認（110がLISTENしているか）：

ss -lntp | grep :110

7. Web+Postfixサーバ：受け口 Postfix（受信→DBへ転送）

インストール＆起動：

dnf install -y postfix
systemctl enable --now postfix


/etc/postfix/main.cf（例）：

myhostname = mail.kuramochi.entrycl.net
mydomain = kuramochi.entrycl.net
myorigin = $mydomain
inet_interfaces = all
inet_protocols = ipv4

# このドメイン宛は受け入れる
mydestination =
virtual_alias_domains = $mydomain
virtual_alias_maps = hash:/etc/postfix/virtual

# DBサーバへ中継（内部SMTP）
relayhost = [<DBサーバPrivateIP>]:25


宛先変換（/etc/postfix/virtual）

banana@kuramochi.entrycl.net  banana@<DBサーバPrivateIP>
apple@kuramochi.entrycl.net   apple@<DBサーバPrivateIP>


反映：

postmap /etc/postfix/virtual
postfix check
systemctl restart postfix

8. 動作確認（必ずこの順）
8-1. DNS確認（どこからでも）
dig MX kuramochi.entrycl.net
dig A mail.kuramochi.entrycl.net

8-2. Web(Postfix) → DB(Postfix) 中継確認

Webサーバで送ってみる：

echo "test mail" | mail -s "hello" banana@kuramochi.entrycl.net
journalctl -u postfix -n 200 --no-pager

8-3. DBサーバで届いているか確認

DBサーバで：

su - banana
ls -la ~/Maildir/new


new にファイルが増えればOK。

9. Outlookでの設定（POP3）

受信（POP3）

サーバ：DB+Dovecotサーバ（到達できる名前/IP）

ポート：110

ユーザー名：banana

パスワード：bananaのLinuxパスワード

送信（SMTP）

サーバ：mail.kuramochi.entrycl.net

ポート：25（まずはこれで）

もしOutlookが「25番の認証なし送信」を許さない場合は、587(Submission)＋SMTP認証を追加する必要があります。

10. よくある詰まりポイント（超重要）

MXが .local を向いている → 外から解決できない（.netで統一）

DB側の110がSGで閉じている → Outlook受信できない

Web→DBの25がSGで閉じている → 受け口から内部へ配送できない

DB側に Maildir がない → 受信箱が作られず保存されない

OutlookがPrivateサーバに到達できない → 踏み台＋ポートフォワードが必要