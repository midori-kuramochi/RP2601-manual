# 追加演習1 ベーシック認証

「ベーシック認証を導入してください」
>ベーシック認証って何？
ブラウザでURLを開いたときに、いきなりページが出るんじゃなくて
- ユーザー名
- パスワード
を入力するポップアップ（ログインダイアログ）が出て、正しい組み合わせなら表示される仕組み。
Apacheだと、サーバ側で「このディレクトリは認証必須」と設定して実現する。


---

### 演習1 手順書：Apache(httpd) にベーシック認証を導入する

OS：Amazon Linux 2023
Web：Apache(httpd)

#### ゴール（成功状態）

`http://www.kuramochi.entrycl.net/` にアクセスすると

1. **ID/パスワード入力の画面**が出る
2. 正しいID/パスワードなら **ページが表示**される

---

#### 前提条件（ここが揃ってないと動かない）

##### A. Webサーバが動いていること

* Apache(httpd) が起動している

確認：

```bash
sudo systemctl status httpd
```

→ `active (running)` ならOK

##### B. ブラウザからWebサーバへ到達できること

* セキュリティグループ（FW）で **TCP 80** が許可されている

確認（サーバ上でOK）：

```bash
curl -I http://127.0.0.1/
```

→ `200` が返ればOK

##### C. [www.kuramochi.entrycl.net](http://www.kuramochi.entrycl.net) が WebサーバのPublic IPを指していること（名前解決）

##### 手順書：権威移譲（パターンB）後に BIND で www.kuramochi.entrycl.netを名前解決させる

**対象**：Amazon Linux 2023 / BIND（named）
**ゴール**:dig www.kuramochi.entrycl.net A で WebサーバのPublic IP が返る
その結果、ブラウザで http://www.kuramochi.entrycl.net/ にアクセスできる

0. 前提条件

kuramochi.entrycl.net は親（entrycl.net）から あなたのNSへ委譲済み
（例：ns.kuramochi.entrycl.net がNSとして登録されている）

あなたは DNSサーバ用EC2 を1台持つ（＝ここでnamedを動かす）

DNSサーバはインターネットから問い合わせを受けるので、SGで以下が必要：
Inbound：UDP 53, TCP 53（送信元は要件に合わせて。演習なら 0.0.0.0/0 になることが多い）
Outbound：All traffic

DNSサーバに 固定のPublic IP（EIP推奨） がある
※NSが指す先IPが変わると委譲が壊れるので、EIPが安全

1. まず「委譲されていること」を確認（親→あなたのNS）

DNSサーバでも自分PCでもOK：

dig NS kuramochi.entrycl.net +short

期待：あなたのNS名が出る（例：ns.kuramochi.entrycl.net など）

2. DNSサーバに BIND(named) を入れて起動

DNSサーバで：
```bash
sudo dnf install -y bind bind-utils
sudo systemctl enable --now named
sudo systemctl status named
```

3. ゾーン定義（kuramochi.entrycl.net を権威として持つ）
3-1. /etc/named.conf に zone を追加
```bash
sudo vi /etc/named.conf
```

末尾あたりに追加（例）：
```
zone "kuramochi.entrycl.net" IN {
    type master;
    file "kuramochi.entrycl.net.zone";
    allow-update { none; };
};
```
※ file は後で作るゾーンファイル名。

4. ゾーンファイル作成（www の A レコードを入れる）
4-1. ゾーンファイルを作成
```bash
sudo vi /var/named/kuramochi.entrycl.net.zone
```

中身テンプレ（そのまま使ってOK、IPだけ置き換え）：
```
$TTL 300
@   IN SOA  ns.kuramochi.entrycl.net. hostmaster.kuramochi.entrycl.net. (
2026021801  ; serial（更新するたびに増やす）
3600        ; refresh
900         ; retry
1209600     ; expire
300 )       ; minimum

    IN NS   ns.kuramochi.entrycl.net.

; NS 自身の名前解決（ゾーン内に必須）
ns  IN A    <DNS_SERVER_PUBLIC_IP>
; www → Webサーバへ
www IN A    <WEB_SERVER_PUBLIC_IP>
```

5. 権限・SELinux（詰まり防止）
```bash
sudo chown root:named /var/named/kuramochi.entrycl.net.zone
sudo chmod 640 /var/named/kuramochi.entrycl.net.zone
```

1. 構文チェック → 反映
6-1. ゾーンチェック
```bash
sudo named-checkconf
sudo named-checkzone kuramochi.entrycl.net /var/named/kuramochi.entrycl.net.zone
```

6-2. 再起動（またはreload）
```bash
sudo systemctl restart named
```

7. 動作確認（最重要：自分のDNSが答えられるか）

7-1. DNSサーバ自身に聞く（ローカル確認）
```bash
dig @127.0.0.1 www.kuramochi.entrycl.net A +short
```
* 期待：<WEB_SERVER_PUBLIC_IP>

7-2. 外からDNSサーバに直接聞く（到達性確認）

DNSサーバのPublic IP を使って：
```bash
dig @<DNS_SERVER_PUBLIC_IP> www.kuramochi.entrycl.net A +short
```
※これが返らないなら SG/NACL/ルートの問題が濃厚。

7-3. “通常の名前解決” で引けるか（委譲が繋がったか）
```bash
dig www.kuramochi.entrycl.net A +short
```

9) よくある詰まり（原因の当たり）

dig @<DNS_PUBLIC_IP> ... が timeout
→ DNSサーバのSGで 53/UDP,TCP が開いてない or NACL

named-checkzone がエラー
→ ゾーンファイルの文法（末尾のドット . や serial）

dig NS ... はあなたのNSなのに、dig www... が引けない
→ ns のA（ゾーン内）や親側の glue/登録が不整合の可能性
（演習環境によっては親側で glue も設定が必要）

ここから先（Web側）

www が引けるようになったら、あとはWeb側（httpd）で

http://www.kuramochi.entrycl.net/ が表示

Basic認証が出る
を確認すればOK。

---

### 手順

#### 1. Apache(httpd) のインストールと起動（済ならスキップ）

```bash
sudo dnf install -y httpd
sudo systemctl enable --now httpd
```

---

#### 2. （任意）トップページを分かりやすくする

It works! のままでもいいけど、確認が楽になるのでおすすめ。
Apache が公開しているトップページ（/var/www/html/index.html）を自分で作って置いている
（=「It works!」の代わりに、分かりやすい自作ページを表示させる）

```bash
sudo tee /var/www/html/index.html >/dev/null <<'EOF'
<!doctype html>
<html><head><meta charset="utf-8"><title>WWW</title></head>
<body><h1>www.kuramochi.entrycl.net</h1></body></html>
EOF
```

---

#### 3. ベーシック認証に必要なツールを入れる（htpasswd）

```bash
sudo dnf install -y httpd-tools
```

---

#### 4. ID/パスワードを登録するファイル（.htpasswd）を作る

##### 4-1. 保存場所を作る（Web公開されない場所に置く）

```bash
sudo mkdir -p /etc/httpd/.auth
```

##### 4-2. ユーザー作成（例：ユーザー名 midori）

初回だけ `-c` を付ける（新規作成）

```bash
sudo htpasswd -c /etc/httpd/.auth/.htpasswd midori
```

→ パスワードを2回入力

※2人目以降を追加する場合は `-c` を外す：

```bash
sudo htpasswd /etc/httpd/.auth/.htpasswd user2
```

---

#### 5. Apacheに「このフォルダは認証必須」を設定する

VirtualHostを使わないので、`conf.d` に設定ファイルを作る。

```bash
sudo vi /etc/httpd/conf.d/basic-auth.conf
```

中身（コピペOK）：

```apache
<Directory "/var/www/html">
    AuthType Basic
    AuthName "WWW Login"
    AuthUserFile /etc/httpd/.auth/.htpasswd
    Require valid-user
</Directory>
```

意味（超ざっくり）：

* `/var/www/html` を見に来た人は
* Basic認証で
* `.htpasswd` に登録されてるユーザーじゃないと
* 見せません

---

#### 6. 設定チェック → 反映

##### 6-1. 設定チェック

```bash
sudo apachectl configtest
```

→ `Syntax OK` を確認

##### 6-2. 反映

```bash
sudo systemctl restart httpd
```

---

### 動作確認（ここで合格）

#### 1. 認証がかかっているか（401になる）

```bash
curl -I http://127.0.0.1/
```

→ `401 Unauthorized` が返れば「認証が効いた」サイン

#### 2. 認証付きでアクセスできるか

```bash
curl -u midori http://127.0.0.1/ | head
```

→ HTMLが返ればOK

#### 3. ブラウザで確認

* DNSができているなら：`http://www.kuramochi.entrycl.net/`
* まだなら：`http://<WebサーバPublicIP>/`

→ ログイン画面が出る
→ `midori` とパスワードを入れる
→ ページが表示されれば成功

---

### つまずいた時（最短で見る場所）

#### 認証画面が出ない

* restrat忘れ：`sudo systemctl restart httpd`
* 設定が読まれてるか：

```bash
sudo httpd -t -D DUMP_INCLUDES | grep basic-auth
```

#### 403 / 500 が出る

* ログを確認：

```bash
sudo tail -n 50 /var/log/httpd/error_log
```

---

#### 重要まとめ（ここだけ覚えればOK）

* ベーシック認証＝「ApacheがID/パスワードでページをロック」
* `.htpasswd` を作る
* `Directory` に認証設定を書く
* reloadして確認（401→認証成功で200）
