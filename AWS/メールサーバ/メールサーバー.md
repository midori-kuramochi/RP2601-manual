## ▼Postfixインストール

### 前提条件
- インバウンドルール
  - SSH 22 MYIP
  - DNS(UDP) 53 [0.0.0.0/16]（VPCのCIDR）
  - SMTP 25 [VPCのCIDR]
  - すべてのICMP - IPv4　[VPCのCIDR]

1. インストール  
<code> $ sudo su - </code>  
<code> # dnf install postfix </code>

1. 起動  
   <code> # systemctl start postfix </code>  
   <code> # systemctl status postfix </code>  
   <code> # ps -ef | grep postfix </code>  
   >root       26167       1  0 01:23 ?        00:00:00 /usr/libexec/postfix/master -w  
   postfix    26168   26167  0 01:23 ?        00:00:00 pickup -l -t unix -u  
   postfix    26169   26167  0 01:23 ?        00:00:00 qmgr -l -t unix -u  
   root       26222    1690  0 01:24 pts/1    00:00:00 grep --color=auto postfix  

   <code> # netstat -ln | grep 25 </code>  
   tcp        0      0 127.0.0.1:25            0.0.0.0:*               LISTEN  
   unix  2      [ ACC ]     STREAM     LISTENING     15525    /run/acpid.socket  

2. mailxインストール  
   <code> # dnf install mailx </code>
   >mailx = コマンドラインからメールを送るし、届いたメールも読むことができる、超軽量なメールアプリ

## Postfixの設定
postfixの基本的な設定ファイル：/etc/postfix/main.cf  

1. バックアップ作成  
   <code># cp /etc/postfix/main.cf /etc/postfix/main.cf`date "+%Y%m%d_%H%M%S"`.bak </code>
   <!-- 
   dateコマンドについて  
   [root@ip-172-31-17-220 ~]# date  
   Fri Jan 23 01:32:38 UTC 2026  
   [root@ip-172-31-17-220 ~]# date "+%Y%m%d_%H%M%S"  20260123_013308  
   [root@ip-172-31-17-220 ~]# date "+%Y_%m_%d_%H_%M_%S"  2026_01_23_01_33_29   
   -->
1. 確認   
   <code> # ll /etc/postfix/ | grep main.cf </code>  
   -rw-r--r--. 1 root root 29709 Jan 16  2024 main.cf  
   -rw-r--r--. 1 root root 29470 Jan 16  2024 main.cf.proto  -rw-r--r--. 1 root root 29709 Jan 23 01:35 main.cf20260123_013557.bak  

1. /etc/postfix/main.cfのコメントアウト行削除→/tmp/main.cfに上書き  
   <code> # grep -v ^# /etc/postfix/main.cf | cat -s > /tmp/main.cf </code>  
   <code> # cp /tmp/main.cf /etc/postfix/main.cf </code>  
   <code> # less /etc/postfix/main.cf </code>  
   <!-- ↓多くて見ずらい
   ![alt text](image.png)
   ↓ #のコメントアウトを削除
   ![alt text](image-1.png) 
   -->

1. postfixの設定ファイル編集  
   <code> # vi /etc/postfix/main.cf </code>  
   ▼追記  
   myhostname = mail.kuramochi.local  
   mydomain = kuramochi.local  
   myorigin = $myhostname  
   mynetworks = 172.31.0.0/16, 127.0.0.1  
   mail_spool_directory = /var/spool/mail/  
   ▼編集  
   >inet_interfaces = localhost   
   ↓  
   inet_interfaces = all    
   >mydestination = $myhostname, localhost.$mydomain, localhost  
   ↓  
   mydestination = $mydomain, $myhostname    
   <!-- 
   <ポイント>  
   ☆mynetworks:メールを使いたいIPアドレスの範囲  
   VPC内の場合は、  
   [AWS]→[インスタンス]→[VPCID]→[IPv4CIDR]→[今回は172.31.0.0/16]
   VPC外の場合は、  
   [AWS]→[インスタンス]→[通したいIPアドレス]
   ☆mail_spool_directory:Maildir形式で保存します！
   mail_spool_directory = /var/spool/mail/  
   -->


1. 再起動  
   <code> # systemctl restart postfix </code>  

## DNSサーバーの設定
1. bindインストール  
   <code> # dnf install bind </code>
1. バックアップ作成  
   <code># cp /etc/named.conf /etc/named.conf.`date "+%Y%m%d_%H%M%S"`.bak </code>
1. bindの設定ファイルの編集  
   <code> # vi /etc/named.conf </code>  
   ▼ 下記参照  
     >options {  
        #listen-on port 53 { 127.0.0.1; };  
        #listen-on-v6 port 53 { ::1; };  
        ...
        allow-query     { any; };  
        #allow-query     { localhost; };  
        ---  
        ↓末尾に追記  
        zone "kuramochi.local" IN {  
        type master;  
        file "/var/named/kuramochi.local.zone";  
        };  
     
1. 間違いがないか確認  
   <code> # named-checkconf </conf>  
   何も表示されなければOK 

2. ゾーンデータベースファイルを新規作成  
   <code> # vi /var/named/kuramochi.local.zone </code>  
   >$TTL 3600  
   @ IN SOA ns.kuramochi.local. test.gmail.com. (  
   20210401 ; serial  
   3600 ; refresh  
   3600 ; retry  
   3600 ; expire  
   3600 ) ; minimum  
             IN NS ns.kuramochi.local.  
             IN MX 10 mail.kuramochi.local.  
        ns   IN A [自分のプライベートIP]  
        mail IN A [自分のプライベートIP]  
3. 間違いがないか確認  
   <code> # named-checkzone kuramochi.local /var/named/kuramochi.local.zone </code>  
4. named起動  
   <code> # systemctl start named </code>    
   <code> # systemctl status named </code>  
5. digコマンドで名前解決テスト  
   <code> # dig @localhost mail.kuramochi.local </code>  
   <!-- 
   ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
   ☆QUERY: 1, ANSWER: 1,になってればOK
    -->
6. DNS参照先サーバーの設定 
   <code> # vi /etc/systemd/resolved.conf </code>  
   ▼下記修正  
   >#DNS=   
   ↓コメントアウトを外す  
   DNS=[DNSサーバーのプライベートIPアドレス]  
   <!-- 
   /etc/systemd/resolved.conf で DNS=[自分のIP] と指定
   「何かわからないドメインがあったら、まずは自分自身（BIND）に聞いてね！」
   という指示をOSに出しています。 
   -->
7. 設定の反映（サービスの再起動）  
   <code> # systemctl restart systemd-resolved.service</code>  
8. 動作確認（digコマンドによる名前解決確認 宛先なしver）  
   <code> # dig mail.kuramochi.local </code>  
   <!-- 
   ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 
   -->

### ログの有効化  
1. rsyslog(メールサーバのログの確認ツール)のインストール   
   <code> # dnf install rsyslog </code>  

1. rsyslogの起動  
   <code> # systemctl start rsyslog </code>  
   <code> # systemctl status rsyslog </code>

## 自分のサーバにメール送信
1. 自分自身に送れるか確認  
   <code> # mail -s <件名> root@kuramochi.local </code>

1. メールログを確認   
   <code> # tail /var/log/maillog | less </code>  
   "status=sent" になっていることを確認
   
1. メールが受信できているか確認
   <code> # mail </code>
   >Heirloom Mail version 12.5 7/5/10.  Type ? for help.
   "/var/spool/mail/root": 1 message 1 new  
   >N  1 root                  Fri Jan 23 04:52  18/559   "kennmei"  
   & 1 #閲覧


## 相手のサーバにメール送信
1. DNS参照先サーバーの設定 
   <code> # vi /etc/systemd/resolved.conf </code>  
   ▼下記修正  
   >#DNS=   
   ↓コメントアウトを外す  
   DNS=[宛先DNSサーバーのプライベートIPアドレス]  
   <!-- 
   /etc/systemd/resolved.conf で DNS=[自分のIP] と指定
   「何かわからないドメインがあったら、まずは自分自身（BIND）に聞いてね！」
   という指示をOSに出しています。 
   -->
1. 設定の反映（サービスの再起動）  
   <code> # systemctl restart systemd-resolved.service</code>  
1. 動作確認（digコマンドによる名前解決確認 宛先なしver）  
   <code> # dig mail.kuramochi.local </code>  
   <!-- 
   ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 
   -->

1. 相手に送れるか確認
   <code> # mail -s <件名> root@[宛先の名前].local </code>

1. メールログを確認   
   <code> # tail /var/log/maillog | less </code>  
   "status=sent" になっていることを確認
   
1. メールが受信できているか確認
   <code> # mail </code>
   >Heirloom Mail version 12.5 7/5/10.  Type ? for help.
   "/var/spool/mail/root": 1 message 1 new  
   >N  1 root                  Fri Jan 23 04:52  18/559   "kennmei"  

## メールアドレス作成
1. ユーザー作成  
   <code> # useradd midori -g mail -M -K MAIL_DIR=/dev/null -s /sbin/nologin </code>  
1. パスワード設定  
   <code> # passwd midori </code>  
   Changing password for user midori.  
   New password:12345  
   Retype new password:12345  
   passwd: all authentication tokens updated successfully.  

## 作成したメアド宛に送る
1. DNS参照先サーバーの設定   
   <code> # vi /etc/systemd/resolved.conf </code>  
   ▼下記修正  
   >#DNS=   
   ↓コメントアウトを外す  
   DNS=[宛先DNSサーバーのプライベートIPアドレス]  

1. 設定の反映（サービスの再起動）  
   <code> # systemctl restart systemd-resolved.service</code>  

1. 動作確認(digコマンドによる名前解決確認)  
   <code> # dig mail.kuramochi.local </code>  

1. 相手に送れるか確認  
   <code> # mail -s <件名> [作成したユーザー名]@kuramochi.local </code>

1. メールログを確認   
   <code> # tail /var/log/maillog | less </code>  
   "status=sent" になっていることを確認
   
1. メールが受信できているか確認
   <code> # mail </code>
   >Heirloom Mail version 12.5 7/5/10.  Type ? for help.
   "/var/spool/mail/root": 1 message 1 new  
   >N  1 root                  Fri Jan 23 04:52  18/559   "kennmei"  


# メールサーバーの構築 - Dovecot
1. Dovecotのインストール  
   <code> # dnf install dovecot </code>
1. dovecot.confのバックアップ作成  
   <code> # cp /etc/dovecot/dovecot.conf /etc/dovecot/dovecot.conf.`date "+%Y%m%d_%H%M%S"`.bak </code>  
1. dovecotの設定  
   <code> # vi /etc/dovecot/dovecot.conf </code>  
   >1. protocols = imap pop3 lmtp submission  
   ↓  
   protocols = pop3  
   
   >2. 末尾に追加  
   mail_location = maildir:/var/spool/mail/%u/

1. 10-ssl.conf | バックアップ  
   <code> # cp /etc/dovecot/conf.d/10-ssl.conf /etc/dovecot/conf.d/10-ssl.conf.`date "+%Y%m%d_%H%M%S"`.bak </code>  
   ssl = required だけ → # ssl = required  
1. バックアップが取れてるか確認  
   <code> # ll /etc/dovecot/conf.d/ | grep 10-ssl.conf </conf>

1. 10-auth.conf | バックアップ  
   <code> # cp /etc/dovecot/conf.d/10-auth.conf /etc/dovecot/conf.d/10-auth.conf.`date "+%Y%m%d_%H%M%S"`.bak </code>  
2. バックアップが取れてるか確認  
   <code> # ll /etc/dovecot/conf.d/ | grep 10-auth.conf </conf>
   > #disable_plaintext_auth = yes だけ   
   →  
   disable_plaintext_auth = no [※コメントアウトを外す]

3. dovecot起動
   <code> # systemctl start dovecot </code>  
   <code> # systemctl status dovecot </code>  
4. dovecot自動起動設定  
   <code> # systemctl enable dovecot </code>  

## telenet
1. telenetインストール
   <code> # dnf install telnet </code>
1. <code> # telnet localhost 110 </code>
   >Trying 127.0.0.1...  
   Connected to localhost.  
   Escape character is '^]'.  
   +OK Dovecot ready.  
   user midori  
   +OK  
   pass 12345  
   +OK Logged in.  
   list  
   +OK 0 messages:  
   .  
   quit  
   +OK Logging out.  


---
1. postfixの設定ファイル編集  
   <code> # vi /etc/postfix/main.cf </code>  
   ▼追記  
   myhostname = mail.neko.local  
   mydomain = neko.local  
   myorigin = $myhostname  
   mynetworks = 172.31.0.0/16, 127.0.0.1  
   mail_spool_directory = /var/spool/mail/  
   ▼編集  
   inet_interfaces = all  
   mydestination = $mydomain, $myhostname  
1. 再起動  
   <code> # systemctl restart postfix </code>  

1. bindの設定ファイルの編集  
   <code> # vi /etc/named.conf </code>  
   ▼ 下記参照  
    ↓末尾に追記    
    >zone "neko.local" IN {  
    type master;  
    file "/var/named/neko.local.zone";  
    };   
1. 間違いがないか確認  
   <code> # named-checkconf </conf>  
   何も表示されなければOK 

2. ゾーンデータベースファイルを新規作成  
   <code> # vi /var/named/neko.local.zone </code>  
   >$TTL 3600  
   @ IN SOA ns.neko.local. test.gmail.com. (  
   20210401 ; serial  
   3600 ; refresh  
   3600 ; retry  
   3600 ; expire  
   3600 ) ; minimum  
             IN NS ns.neko.local.  
             IN MX 10 mail.neko.local.  
        ns   IN A [自分のプライベートIP]  
        mail IN A [自分のプライベートIP]  
3. 間違いがないか確認  
   <code> # named-checkzone neko.local /var/named/kuramochi.local.zone </code>  
4. named起動  
   <code> # systemctl restart named </code>    
   <code> # systemctl status named </code>  
5. digコマンドで名前解決テスト  
   <code> # dig @localhost mail.neko.local </code>  
   <!-- 
   ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1
   ☆QUERY: 1, ANSWER: 1,になってればOK
    -->
6. DNS参照先サーバーの設定 
   <code> # vi /etc/systemd/resolved.conf </code>  
   ▼下記修正  
   >#DNS=   
   ↓コメントアウトを外す  
   DNS=[DNSサーバーのプライベートIPアドレス]  
   <!-- 
   /etc/systemd/resolved.conf で DNS=[自分のIP] と指定
   「何かわからないドメインがあったら、まずは自分自身（BIND）に聞いてね！」
   という指示をOSに出しています。 
   -->
7. 設定の反映（サービスの再起動）  
   <code> # systemctl restart systemd-resolved.service</code>  
8. 動作確認（digコマンドによる名前解決確認 宛先なしver）  
   <code> # dig mail.neko.local </code>  
   <!-- 
   ;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1 
   -->